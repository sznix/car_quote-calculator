name: ci

on:
  push:
    branches:
      - main
      - 'feat/**'
      - 'codex/**'
      - 'cursor/**'
  pull_request:
    branches:
      - main
      - 'feat/**'
      - 'codex/**'
      - 'cursor/**'

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Setup Node
        if: ${{ hashFiles('package.json') != '' }}
        uses: actions/setup-node@v4
        with:
          node-version: 20
      - name: Install
        if: ${{ hashFiles('package.json') != '' }}
        run: |
          if [ -f package-lock.json ] || [ -f npm-shrinkwrap.json ]; then
            npm ci
          else
            npm i
          fi
      - name: Lint
        if: ${{ hashFiles('package.json') != '' }}
        run: npm run lint --if-present
      - name: Typecheck
        if: ${{ hashFiles('package.json') != '' }}
        run: npm run typecheck --if-present
      - name: Test
        if: ${{ hashFiles('package.json') != '' }}
        run: npm test --if-present
      - name: Build
        if: ${{ hashFiles('package.json') != '' }}
        run: npm run build --if-present
      - name: WP QA checks
        if: ${{ hashFiles('**/*.php') != '' }}
        run: |
          set -euo pipefail
          shopt -s globstar nullglob
          # Limit search scope to repo, excluding common vendor dirs
          EXCLUDES=( -path './.git/*' -o -path './node_modules/*' -o -path './vendor/*' -o -path './dist/*' -o -path './build/*' )
          # Build a null-delimited array of PHP files to safely handle spaces
          mapfile -d '' -t php_files < <(find . -type f -name '*.php' ! \( "${EXCLUDES[@]}" \) -print0)

          # If nothing to check (all PHP files excluded), exit early
          if [ ${#php_files[@]} -eq 0 ]; then
            exit 0
          fi

          # 1) Enqueue only with shortcode context present
          while IFS= read -r -d '' f; do
            grep -Eq 'has_shortcode\(|add_shortcode\(|shortcode_atts\(' "$f" || { echo "::error file=$f::Asset enqueue must be gated by a shortcode (has_shortcode/add_shortcode)."; exit 1; }
          done < <(grep -IlZ -E 'wp_enqueue_script|wp_enqueue_style' -- "${php_files[@]}" || true)

          # 2) dbDelta is called safely with upgrade.php required
          while IFS= read -r -d '' f; do
            grep -Eq 'require_once.*wp-admin/includes/upgrade\.php' "$f" || { echo "::error file=$f::dbDelta requires including wp-admin/includes/upgrade.php"; exit 1; }
          done < <(grep -IlZ 'dbDelta\(' -- "${php_files[@]}" || true)

          # 3) No global leaks (allow only $wpdb)
          violations=0
          while IFS=: read -r file line content; do
            # Allow only lines that declare $wpdb (optionally repeated) and nothing else
            if [[ "$content" =~ ^[[:space:]]*global[[:space:]]+(\$wpdb[[:space:]]*)(,[[:space:]]*\$wpdb[[:space:]]*)*;([[:space:]]*(//|#).*)?$ ]]; then
              continue
            fi
            echo "::error file=$file,line=$line::Avoid global variables (except \$wpdb)."
            violations=1
          done < <(grep -InE '^[[:space:]]*global[[:space:]]+\$' -- "${php_files[@]}" || true)

          if [ "$violations" -ne 0 ]; then
            exit 1
          fi
